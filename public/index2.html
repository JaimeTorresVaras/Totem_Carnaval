<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Totem Bsale</title>
  <style>
    body {
      background:#0b1220; color:#eaf2ff;
      font-family:sans-serif; display:flex; flex-direction:column;
      align-items:center; justify-content:center; height:100vh; gap:20px;
      margin:0;
    }
    h1 { font-size: 2em; margin:0; }
    .result { text-align:center; min-height: 180px; }
    .name { font-size: 2.2em; font-weight: 700; }
    .sku { font-size: 1.4em; margin-top: 8px; opacity: .9; }
    .price { font-size: 2.4em; margin-top: 12px; font-weight: 800; }
    #status { margin-top:15px; min-height: 22px; opacity:.9; }
    input#barcodeInput {
      opacity:0; position:absolute; left:-9999px; width:1px; height:1px;
    }
  </style>
</head>
<body>
  <h1>Totem Bsale</h1>

  <div class="result" id="result">
    <div class="name" id="name"></div>
    <div class="sku" id="sku"></div>
    <div class="price" id="price"></div>
  </div>

  <div id="status">Escanea un código...</div>

  <input id="barcodeInput" autocomplete="off" />

  <script>
    const input   = document.getElementById("barcodeInput");
    const nameEl  = document.getElementById("name");
    const skuEl   = document.getElementById("sku");
    const priceEl = document.getElementById("price");
    const statusEl= document.getElementById("status");

    // Mantén el foco para lectores USB
    function focusInput(){ setTimeout(()=>input.focus(), 0); }
    window.addEventListener("load", focusInput);
    window.addEventListener("click", focusInput);
    setInterval(() => { if (document.activeElement !== input) focusInput(); }, 1500);

    function CLP(n){
      try {
        return new Intl.NumberFormat("es-CL", { style:"currency", currency:"CLP", maximumFractionDigits:0 }).format(n);
      } catch { return `$${Math.round(n ?? 0)}`; }
    }

    function clearUI(){
      nameEl.textContent  = "";
      skuEl.textContent   = "";
      priceEl.textContent = "";
    }

    async function lookup(barcode){
      clearUI();
      statusEl.textContent = "Buscando producto...";
      try {
        // Si quieres forzar una lista por query, agrega &priceListId=1
        const resp = await fetch(`/api/lookup?barcode=${encodeURIComponent(barcode)}`, { headers: { "Cache-Control": "no-store" } });
        const data = await resp.json();

        if (data.error){
          statusEl.textContent = data.error;
          return;
        }

        // Cada escaneo reemplaza TODO:
        nameEl.textContent  = data.name || "Producto";
        skuEl.textContent   = data.sku ? `SKU: ${data.sku}` : "";
        priceEl.textContent = (data.price !== undefined && data.price !== null)
          ? `Precio: ${CLP(Number(data.price))}`
          : "Precio: —";

        statusEl.textContent = "";
      } catch (e){
        console.error(e);
        statusEl.textContent = "Error al consultar producto";
      }
    }

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter"){
        const barcode = input.value.trim();
        input.value = "";
        if (barcode) lookup(barcode);
      }
    });

    // Fallback si el lector pega \n
    input.addEventListener("input", () => {
      if (input.value.includes("\n")) {
        const code = input.value.replace(/\r?\n/g,"").trim();
        input.value = "";
        if (code) lookup(code);
      }
    });
  </script>
</body>
</html>
